version: 2.1

jobs:
  formatting:
    working_directory: ~/home-robot
    resource_class: large
    docker:
      - image: circleci/python:3.8
    steps:
      - checkout
      - run:
          name: Run black formatting
          command: |
            pip install black==22.3.0
            black --check .

  integration-sim:
    working_directory: ~/home-robot
    resource_class: large
    docker:
      - image: continuumio/miniconda3
    steps:
      - checkout
      - run:
          name: Install Submodules
          command: git submodule sync && git submodule update --init
      - run: 
          name: Setup conda & mamba
          command: |
            apt-get update
            apt-get install -y build-essential
            conda init bash
            source ~/.bashrc
            conda install -y -n base -c conda-forge mamba
      - restore_cache:
          key: deps9-{{ .Branch }}-{{ checksum "src/home_robot/environment.yml" }}
      - run:
          name: Setup env
          command: |
            [ -d ~/env_home_robot ] || mamba env create -f src/home_robot/environment.yml -p ~/env_home_robot
      - save_cache:
          key: deps9-{{ .Branch }}-{{ checksum "src/home_robot/environment.yml" }}
          paths:
            - "~/env_home_robot"
            - "/usr/lib"
      - run:
          name: Install libraries and run tests
          command: |
            source ~/.bashrc
            conda activate ~/env_home_robot
            cd ~/home-robot/src/home_robot
            pip install -e .
            cd ~/home-robot/src/home_robot_sim
            pip install -e .
            cd ~/home-robot
            pytest tests/

workflows:
  main:
    jobs:
      - formatting
      - integration-sim
